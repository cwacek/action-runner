## ADDED Requirements

### Requirement: Configuration status monitoring

The system SHALL provide visibility into configuration completeness via the status API.

#### Scenario: Missing private key detection
- **WHEN** the status API is called
- **AND** the GitHub App private key secret contains a placeholder value or is empty
- **THEN** the response includes `configuration.privateKeyConfigured: false`
- **AND** the overall status is `degraded`
- **AND** the message includes "GitHub App private key not configured"

#### Scenario: Complete configuration
- **WHEN** the status API is called
- **AND** the GitHub App private key secret contains a valid PEM key
- **THEN** the response includes `configuration.privateKeyConfigured: true`
- **AND** the configuration status does not affect the overall system status

#### Scenario: Webhook handler with missing private key
- **WHEN** a webhook request is received
- **AND** the GitHub App private key is not configured
- **THEN** the handler returns a 503 Service Unavailable error
- **AND** the error message indicates the private key needs to be configured

## MODIFIED Requirements

### Requirement: Deploy via CDK construct

The system SHALL provide two AWS CDK stacks for deploying the complete solution: a foundation stack for long-lived infrastructure, and an application stack for the webhook API and application resources.

#### Scenario: Two-stack deployment
- **WHEN** a user deploys the system for the first time
- **THEN** they first deploy `SpotRunnerFoundationStack` to create VPC and private key secret
- **AND** then create a GitHub App on GitHub (without webhook URL)
- **AND** then download the private key from GitHub and upload it to the foundation stack's secret
- **AND** then deploy `SpotRunnerStack` with GitHub App ID and foundation stack references
- **AND** then update the GitHub App settings with the webhook URL and secret from the app stack outputs

#### Scenario: Foundation stack deployment
- **WHEN** a user instantiates `SpotRunnerFoundationStack`
- **THEN** the stack creates VPC, NAT gateway, and runner security group
- **AND** creates a Secrets Manager secret with a placeholder value for the GitHub App private key
- **AND** outputs the private key secret ARN for the application stack

#### Scenario: Application stack deployment
- **WHEN** a user instantiates `SpotRunnerStack` with foundation resources and GitHub App ID
- **THEN** the stack creates an API Gateway REST API with the webhook endpoint
- **AND** generates a webhook secret and stores it in Secrets Manager
- **AND** deploys all application resources (Lambdas, DynamoDB, Image Builder)
- **AND** imports the private key secret from foundation stack
- **AND** outputs the webhook URL and webhook secret value for GitHub App configuration

#### Scenario: Customized CDK deployment
- **WHEN** a user provides optional parameters (custom runner configs, timeout values, spot strategy)
- **THEN** the application stack applies those customizations
- **AND** validates parameter combinations

### Requirement: Secure secrets management

The system SHALL manage sensitive configuration in Secrets Manager, with the private key uploaded by the user after GitHub App creation and the webhook secret generated by the application stack.

#### Scenario: Private key secret in foundation stack
- **WHEN** the foundation stack is deployed
- **THEN** a Secrets Manager secret is created for the private key with a placeholder value
- **AND** the secret has a retention policy

#### Scenario: Private key upload workflow
- **WHEN** a user creates a GitHub App on GitHub
- **THEN** GitHub generates the private key
- **AND** the user downloads the private key from GitHub
- **AND** the user uploads the private key to the foundation stack's Secrets Manager secret

#### Scenario: Webhook secret in application stack
- **WHEN** the application stack is deployed
- **THEN** the webhook secret is generated using Secrets Manager's generateSecretString
- **AND** the webhook secret value is output for GitHub App configuration

#### Scenario: Secrets access in application stack
- **WHEN** the application stack is deployed
- **THEN** it imports the private key secret by ARN from the foundation stack
- **AND** Lambda has IAM permissions to read both secrets

#### Scenario: Secrets rotation
- **WHEN** a user rotates the GitHub App private key
- **THEN** they generate a new private key on GitHub
- **AND** upload the new private key to Secrets Manager
- **AND** the system uses the new key on next token generation

### Requirement: Output essential configuration values

The system SHALL output values needed for GitHub App setup from the appropriate stack.

#### Scenario: Foundation stack outputs
- **WHEN** foundation stack deployment completes
- **THEN** the stack outputs:
  - Private key secret ARN (for application stack reference and manual upload target)
  - VPC ID
  - Runner security group ID

#### Scenario: Application stack outputs
- **WHEN** application stack deployment completes
- **THEN** the stack outputs:
  - Webhook URL (for GitHub App configuration)
  - Webhook secret value (for GitHub App configuration)
  - Lambda function ARN
  - State table name

### Requirement: Application stack required parameters

The system SHALL require the GitHub App ID, Server URL, and foundation stack references for the application stack.

#### Scenario: Required parameters
- **WHEN** deploying the application stack
- **THEN** `githubAppId` and `githubServerUrl` are required as external inputs
- **AND** `vpc`, `runnerSecurityGroup`, and `privateKeySecret` are required from the foundation stack

#### Scenario: No webhook URL or secret required upfront
- **WHEN** deploying the application stack
- **THEN** no webhook URL or webhook secret input is required
- **AND** the stack generates and outputs these values
